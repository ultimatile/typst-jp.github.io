{"route":"/docs/reference/introspection/state/","title":"State","description":"Documentation for the State type.","part":null,"outline":[{"id":"summary","name":"概要","children":[]},{"id":"state-and-markup","name":"状態と文書のマークアップ","children":[]},{"id":"state-in-typst","name":"Typstにおける状態管理","children":[]},{"id":"タイムトラベル","name":"タイムトラベル","children":[]},{"id":"caution","name":"注意事項","children":[]},{"id":"constructor","name":"コンストラクタ","children":[{"id":"constructor-key","name":"key","children":[]},{"id":"constructor-init","name":"init","children":[]}]},{"id":"definitions","name":"定義","children":[{"id":"definitions-get","name":"Get","children":[]},{"id":"definitions-at","name":"At","children":[{"id":"definitions-at-selector","name":"selector","children":[]}]},{"id":"definitions-final","name":"Final","children":[]},{"id":"definitions-update","name":"Update","children":[{"id":"definitions-update-update","name":"update","children":[]}]}]}],"body":{"kind":"type","content":{"name":"state","title":"State","keywords":[],"oneliner":"文書中の状態の管理。","details":"<p>文書中の状態の管理。</p>\n<p>文書中で何回か計算を行い、最後の計算結果を次の計算で使用するために記憶しておきたいとします。\n以下と同等のコードを試すと10、13、26、21と出力されることを期待するでしょう。\nしかしTypstでは<strong>そうはなりません</strong>。\nこのコードを試してみると、Typstは <em>Variables from outside the function are read-only and cannot be modified.</em> というエラーメッセージを出力することが分かります。</p>\n<pre><code><span class=\"typ-comment\">// This doesn&#39;t work!</span>\n<span class=\"typ-key\">#</span><span class=\"typ-key\">let</span> x <span class=\"typ-op\">=</span> <span class=\"typ-num\">0</span>\n<span class=\"typ-key\">#</span><span class=\"typ-key\">let</span> <span class=\"typ-func\">compute</span><span class=\"typ-punct\">(</span>expr<span class=\"typ-punct\">)</span> <span class=\"typ-op\">=</span> <span class=\"typ-punct\">{</span>\n  x <span class=\"typ-op\">=</span> <span class=\"typ-func\">eval</span><span class=\"typ-punct\">(</span>\n    expr<span class=\"typ-punct\">.</span><span class=\"typ-func\">replace</span><span class=\"typ-punct\">(</span><span class=\"typ-str\">&quot;x&quot;</span><span class=\"typ-punct\">,</span> <span class=\"typ-func\">str</span><span class=\"typ-punct\">(</span>x<span class=\"typ-punct\">)</span><span class=\"typ-punct\">)</span>\n  <span class=\"typ-punct\">)</span>\n  <span class=\"typ-punct\">[</span>New value is <span class=\"typ-pol\">#</span><span class=\"typ-pol\">x</span>. <span class=\"typ-punct\">]</span>\n<span class=\"typ-punct\">}</span>\n\n<span class=\"typ-func\">#</span><span class=\"typ-func\">compute</span><span class=\"typ-punct\">(</span><span class=\"typ-str\">&quot;10&quot;</span><span class=\"typ-punct\">)</span> <span class=\"typ-escape\">\\</span>\n<span class=\"typ-func\">#</span><span class=\"typ-func\">compute</span><span class=\"typ-punct\">(</span><span class=\"typ-str\">&quot;x + 3&quot;</span><span class=\"typ-punct\">)</span> <span class=\"typ-escape\">\\</span>\n<span class=\"typ-func\">#</span><span class=\"typ-func\">compute</span><span class=\"typ-punct\">(</span><span class=\"typ-str\">&quot;x * 2&quot;</span><span class=\"typ-punct\">)</span> <span class=\"typ-escape\">\\</span>\n<span class=\"typ-func\">#</span><span class=\"typ-func\">compute</span><span class=\"typ-punct\">(</span><span class=\"typ-str\">&quot;x - 5&quot;</span><span class=\"typ-punct\">)</span>\n</code></pre>\n<h2 id=\"state-and-markup\">状態と文書のマークアップ</h2>\n<p>なぜこうなるのでしょうか？\n一般的に副作用を伴うこの手の計算は文書のマークアップにおいて問題を引き起こすためで、Typstではこれをエラーとして扱います。\nこの結果を理解するには、計算処理が文書内で生成物がレイアウトされる順序と同じ順序で行われる必要があります。\n今回の単純な例ではこの条件が満たされますが、一般的には必ずしもそうとは限りません。</p>\n<p>見出しの番号付けという、類似した状態ですが、少し異なる例を見てみましょう。\n各見出しで見出しカウンターの値を増やしたいとします。\n簡単そうですよね？\nただ1を足すだけです。\n残念ながらそう単純ではないのです。\n以下の例を考えます。</p>\n<div class=\"previewed-code\"><pre><code><span class=\"typ-key\">#</span><span class=\"typ-key\">set</span> <span class=\"typ-func\">heading</span><span class=\"typ-punct\">(</span>numbering<span class=\"typ-punct\">:</span> <span class=\"typ-str\">&quot;1.&quot;</span><span class=\"typ-punct\">)</span>\n<span class=\"typ-key\">#</span><span class=\"typ-key\">let</span> <span class=\"typ-func\">template</span><span class=\"typ-punct\">(</span>body<span class=\"typ-punct\">)</span> <span class=\"typ-op\">=</span> <span class=\"typ-punct\">[</span>\n  <span class=\"typ-heading\">= Outline</span>\n  <span class=\"typ-escape\">...</span>\n  <span class=\"typ-pol\">#</span><span class=\"typ-pol\">body</span>\n<span class=\"typ-punct\">]</span>\n\n<span class=\"typ-key\">#</span><span class=\"typ-key\">show</span><span class=\"typ-punct\">:</span> <span class=\"typ-func\">template</span>\n\n<span class=\"typ-heading\">= Introduction</span>\n<span class=\"typ-escape\">...</span>\n</code></pre><div class=\"preview\"><img src=\"/docs/assets/382f18a61cf8fa6150847e8c9bd970c0.png\" alt=\"Preview\"></div></div>\n<p>ここで、Typstはまずshowルール以降の文書本体を処理し、<code>Introduction</code>見出しを検知します。\n続いて<code>template</code>関数に生成コンテンツを渡します。\nその後、初めて<code>Outline</code>を検知します。\n単にカウンター値を増やすと<code>Introduction</code>は<code>1</code>に、<code>Outline</code>は<code>2</code>となります。</p>\n<h2 id=\"state-in-typst\">Typstにおける状態管理</h2>\n<p>それでは代わりにどうするのでしょうか？\nTypstの状態管理システムを使用します。\n識別用のキーとなる文字列とオプションの初期値とともに<code>state</code>関数を呼び出すことで状態値が得られます。\nこの状態値はいくつかの関数を公開しており、最も重要な2つの関数が<code>get</code>と<code>update</code>です。</p>\n<ul>\n<li>\n<p><a href=\"/docs/reference/introspection/state/#definitions-get\"><code>get</code></a>関数は状態の現在値を取得します。\n値は文書中で変化するため、これは<a href=\"/docs/reference/context/\">コンテキスト</a>が利用可能な場合にのみ使用できる <em>コンテキスト</em> 関数です。</p>\n</li>\n<li>\n<p><a href=\"/docs/reference/introspection/state/#definitions-update\"><code>update</code></a>関数は状態に修正を加えます。\n任意の値が使用できます。\n関数ではない値が渡された場合、状態にその値が設定されます。\n関数が与えられた場合、その関数は前の状態を受け取り、新しい状態を返さなければなりません。</p>\n</li>\n</ul>\n<p>最初の例は以下のようになります。</p>\n<div class=\"previewed-code\"><pre><code><span class=\"typ-key\">#</span><span class=\"typ-key\">let</span> s <span class=\"typ-op\">=</span> <span class=\"typ-func\">state</span><span class=\"typ-punct\">(</span><span class=\"typ-str\">&quot;x&quot;</span><span class=\"typ-punct\">,</span> <span class=\"typ-num\">0</span><span class=\"typ-punct\">)</span>\n<span class=\"typ-key\">#</span><span class=\"typ-key\">let</span> <span class=\"typ-func\">compute</span><span class=\"typ-punct\">(</span>expr<span class=\"typ-punct\">)</span> <span class=\"typ-op\">=</span> <span class=\"typ-punct\">[</span>\n  <span class=\"typ-pol\">#</span><span class=\"typ-pol\">s</span><span class=\"typ-punct\">.</span><span class=\"typ-func\">update</span><span class=\"typ-punct\">(</span>x <span class=\"typ-op\">=&gt;</span>\n    <span class=\"typ-func\">eval</span><span class=\"typ-punct\">(</span>expr<span class=\"typ-punct\">.</span><span class=\"typ-func\">replace</span><span class=\"typ-punct\">(</span><span class=\"typ-str\">&quot;x&quot;</span><span class=\"typ-punct\">,</span> <span class=\"typ-func\">str</span><span class=\"typ-punct\">(</span>x<span class=\"typ-punct\">)</span><span class=\"typ-punct\">)</span><span class=\"typ-punct\">)</span>\n  <span class=\"typ-punct\">)</span>\n  New value is <span class=\"typ-key\">#</span><span class=\"typ-key\">context</span> s<span class=\"typ-punct\">.</span><span class=\"typ-func\">get</span><span class=\"typ-punct\">(</span><span class=\"typ-punct\">)</span>.\n<span class=\"typ-punct\">]</span>\n\n<span class=\"typ-func\">#</span><span class=\"typ-func\">compute</span><span class=\"typ-punct\">(</span><span class=\"typ-str\">&quot;10&quot;</span><span class=\"typ-punct\">)</span> <span class=\"typ-escape\">\\</span>\n<span class=\"typ-func\">#</span><span class=\"typ-func\">compute</span><span class=\"typ-punct\">(</span><span class=\"typ-str\">&quot;x + 3&quot;</span><span class=\"typ-punct\">)</span> <span class=\"typ-escape\">\\</span>\n<span class=\"typ-func\">#</span><span class=\"typ-func\">compute</span><span class=\"typ-punct\">(</span><span class=\"typ-str\">&quot;x * 2&quot;</span><span class=\"typ-punct\">)</span> <span class=\"typ-escape\">\\</span>\n<span class=\"typ-func\">#</span><span class=\"typ-func\">compute</span><span class=\"typ-punct\">(</span><span class=\"typ-str\">&quot;x - 5&quot;</span><span class=\"typ-punct\">)</span>\n</code></pre><div class=\"preview\"><img src=\"/docs/assets/4ef077712c72e97c10569d045d9f7e7b.png\" alt=\"Preview\"></div></div>\n<p>Typstが管理する状態は常に評価順ではなくレイアウト順で更新されます。\n<code>update</code>メソッドはコンテンツを返し、その影響は文書に返されたコンテンツが挿入された場所で生じます。</p>\n<p>このようにして、計算結果を変数に保存できるようになり、正しい結果を表示しています。</p>\n<div class=\"previewed-code\"><pre><code><span class=\"typ-escape\">...</span>\n\n<span class=\"typ-key\">#</span><span class=\"typ-key\">let</span> more <span class=\"typ-op\">=</span> <span class=\"typ-punct\">[</span>\n  <span class=\"typ-func\">#</span><span class=\"typ-func\">compute</span><span class=\"typ-punct\">(</span><span class=\"typ-str\">&quot;x * 2&quot;</span><span class=\"typ-punct\">)</span> <span class=\"typ-escape\">\\</span>\n  <span class=\"typ-func\">#</span><span class=\"typ-func\">compute</span><span class=\"typ-punct\">(</span><span class=\"typ-str\">&quot;x - 5&quot;</span><span class=\"typ-punct\">)</span>\n<span class=\"typ-punct\">]</span>\n\n<span class=\"typ-func\">#</span><span class=\"typ-func\">compute</span><span class=\"typ-punct\">(</span><span class=\"typ-str\">&quot;10&quot;</span><span class=\"typ-punct\">)</span> <span class=\"typ-escape\">\\</span>\n<span class=\"typ-func\">#</span><span class=\"typ-func\">compute</span><span class=\"typ-punct\">(</span><span class=\"typ-str\">&quot;x + 3&quot;</span><span class=\"typ-punct\">)</span> <span class=\"typ-escape\">\\</span>\n<span class=\"typ-pol\">#</span><span class=\"typ-pol\">more</span>\n</code></pre><div class=\"preview\"><img src=\"/docs/assets/95e487c3196497c7c1a2164ab7894ce0.png\" alt=\"Preview\"></div></div>\n<p>この例はもちろん少々極端ですが、これが実際に本当に必要となることがよくあります！\n良い例は見出しカウンターです。\nこれはTypstの<a href=\"/docs/reference/introspection/counter/\">カウンターシステム</a>が状態システムにとてもよく似ているためです。</p>\n<h2 id=\"タイムトラベル\">タイムトラベル</h2>\n<p>Typstの状態管理システムを使用するとタイムトラベルもできます！\n文書内の任意の位置でその状態がどの値になっているのかを、どこからでも突き止めることができます。\n特に、<code>at</code>メソッドを用いると特定の任意の位置での状態値が取得でき、<code>final</code>メソッドを用いると文書の終わりでの状態値を取得できます。</p>\n<div class=\"previewed-code\"><pre><code><span class=\"typ-escape\">...</span>\n\nValue at <span class=\"typ-raw\">`&lt;here&gt;`</span> is\n<span class=\"typ-key\">#</span><span class=\"typ-key\">context</span> s<span class=\"typ-punct\">.</span><span class=\"typ-func\">at</span><span class=\"typ-punct\">(</span><span class=\"typ-label\">&lt;here&gt;</span><span class=\"typ-punct\">)</span>\n\n<span class=\"typ-func\">#</span><span class=\"typ-func\">compute</span><span class=\"typ-punct\">(</span><span class=\"typ-str\">&quot;10&quot;</span><span class=\"typ-punct\">)</span> <span class=\"typ-escape\">\\</span>\n<span class=\"typ-func\">#</span><span class=\"typ-func\">compute</span><span class=\"typ-punct\">(</span><span class=\"typ-str\">&quot;x + 3&quot;</span><span class=\"typ-punct\">)</span> <span class=\"typ-escape\">\\</span>\n<span class=\"typ-strong\">*Here.*</span> <span class=\"typ-label\">&lt;here&gt;</span> <span class=\"typ-escape\">\\</span>\n<span class=\"typ-func\">#</span><span class=\"typ-func\">compute</span><span class=\"typ-punct\">(</span><span class=\"typ-str\">&quot;x * 2&quot;</span><span class=\"typ-punct\">)</span> <span class=\"typ-escape\">\\</span>\n<span class=\"typ-func\">#</span><span class=\"typ-func\">compute</span><span class=\"typ-punct\">(</span><span class=\"typ-str\">&quot;x - 5&quot;</span><span class=\"typ-punct\">)</span>\n</code></pre><div class=\"preview\"><img src=\"/docs/assets/1526d8d8866c90f34a790b4fa9b8eba0.png\" alt=\"Preview\"></div></div>\n<h2 id=\"caution\">注意事項</h2>\n<p>全ての状態値を解決するために、Typstはコードを複数回評価します。\nしかしながら、実際に状態操作が完全に解決されるかは保証されません。</p>\n<p>例えば、状態の最終的な値に依存する更新を行う状態を作成した場合、決して収束しなくなるでしょう。\n以下の例はこの実演です。\n状態を<code>1</code>で初期化し、続いて自身の最終値に1を足した値に更新します。\nしたがって値は<code>2</code>になるべきですが、最終値が<code>2</code>となったので<code>3</code>に更新します。以下同様です。\nこの例では有限値が表示されていますが、これは単にTypstが数回試行した後に諦めるためです。</p>\n<div class=\"previewed-code\"><pre><code><span class=\"typ-comment\">// This is bad!</span>\n<span class=\"typ-key\">#</span><span class=\"typ-key\">let</span> s <span class=\"typ-op\">=</span> <span class=\"typ-func\">state</span><span class=\"typ-punct\">(</span><span class=\"typ-str\">&quot;x&quot;</span><span class=\"typ-punct\">,</span> <span class=\"typ-num\">1</span><span class=\"typ-punct\">)</span>\n<span class=\"typ-key\">#</span><span class=\"typ-key\">context</span> s<span class=\"typ-punct\">.</span><span class=\"typ-func\">update</span><span class=\"typ-punct\">(</span>s<span class=\"typ-punct\">.</span><span class=\"typ-func\">final</span><span class=\"typ-punct\">(</span><span class=\"typ-punct\">)</span> <span class=\"typ-op\">+</span> <span class=\"typ-num\">1</span><span class=\"typ-punct\">)</span>\n<span class=\"typ-key\">#</span><span class=\"typ-key\">context</span> s<span class=\"typ-punct\">.</span><span class=\"typ-func\">get</span><span class=\"typ-punct\">(</span><span class=\"typ-punct\">)</span>\n</code></pre><div class=\"preview\"><img src=\"/docs/assets/e0006b34068755bbf3085f4912651e6c.png\" alt=\"Preview\"></div></div>\n<p>一般に、コンテキスト内部で更新を行う状態を作成しないようにしてください。\n可能であれば、更新内容をコンテキストに依存しない値として、あるいは前の値から新しい値を計算する関数として定義してください。\nどうしても避けられない場合がありますが、その場合は結果が適切に収束することを保証することはあなたの責任です。</p>","constructor":{"path":[],"name":"state","title":"Construct","keywords":[],"oneliner":"キーで識別される新しい状態の作成。","element":false,"contextual":false,"deprecation":null,"details":"<p>キーで識別される新しい状態の作成。</p>","example":null,"self":false,"params":[{"name":"key","details":"<p>状態を識別するキー。</p>","example":null,"types":["str"],"strings":[],"default":null,"positional":true,"named":false,"required":true,"variadic":false,"settable":false},{"name":"init","details":"<p>状態の初期値。</p>","example":null,"types":["any"],"strings":[],"default":"<code><span class=\"typ-key\">none</span></code>","positional":true,"named":false,"required":false,"variadic":false,"settable":false}],"returns":["state"],"scope":[]},"scope":[{"path":["state"],"name":"get","title":"Get","keywords":[],"oneliner":"現在のロケーションでの状態値を取得。","element":false,"contextual":true,"deprecation":null,"details":"<p>現在のロケーションでの状態値を取得。</p>\n<p>これは<code>state<span class=\"typ-punct\">.</span><span class=\"typ-func\">at</span><span class=\"typ-punct\">(</span><span class=\"typ-func\">here</span><span class=\"typ-punct\">(</span><span class=\"typ-punct\">)</span><span class=\"typ-punct\">)</span></code>と等価です。</p>","example":null,"self":true,"params":[],"returns":["any"],"scope":[]},{"path":["state"],"name":"at","title":"At","keywords":[],"oneliner":"指定したセレクターで一意に特定される対象の状態値を取得。","element":false,"contextual":true,"deprecation":null,"details":"<p>指定したセレクターで一意に特定される対象の状態値を取得。</p>\n<p><code>selector</code>は文書中で厳密に1つだけの要素にマッチしなければなりません。\nこの目的で最も便利なセレクターは<a href=\"/docs/reference/foundations/label/\">ラベル</a>と<a href=\"/docs/reference/introspection/location/\">ロケーション</a>です。</p>","example":null,"self":true,"params":[{"name":"selector","details":"<p>状態値を取得する場所。</p>","example":null,"types":["label","selector","location","function"],"strings":[],"default":null,"positional":true,"named":false,"required":true,"variadic":false,"settable":false}],"returns":["any"],"scope":[]},{"path":["state"],"name":"final","title":"Final","keywords":[],"oneliner":"文書の終わりでの状態値の取得。","element":false,"contextual":true,"deprecation":null,"details":"<p>文書の終わりでの状態値の取得。</p>","example":null,"self":true,"params":[],"returns":["any"],"scope":[]},{"path":["state"],"name":"update","title":"Update","keywords":[],"oneliner":"状態値を更新。","element":false,"contextual":false,"deprecation":null,"details":"<p>状態値を更新。</p>\n<p>更新は、返り値であるコンテンツが文書中に挿入された位置で適用されます。\n文書中に出力がなければ何も起こりません！\n例えば<code><span class=\"typ-key\">let</span> _ <span class=\"typ-op\">=</span> <span class=\"typ-func\">state</span><span class=\"typ-punct\">(</span><span class=\"typ-str\">&quot;key&quot;</span><span class=\"typ-punct\">)</span><span class=\"typ-punct\">.</span><span class=\"typ-func\">update</span><span class=\"typ-punct\">(</span><span class=\"typ-num\">7</span><span class=\"typ-punct\">)</span></code>と書いた場合が、この何も起きないときに該当します。\n状態の更新は常にレイアウト順に適用されるため、この場合にはTypstはいつ状態を更新するのか分かりません。</p>","example":null,"self":true,"params":[{"name":"update","details":"<p>関数ではない値が与えられた場合、状態にその値を設定します。\n関数が与えられた場合、その関数は前の状態を受け取り、新しい状態を返さなければなりません。</p>","example":null,"types":["any","function"],"strings":[],"default":null,"positional":true,"named":false,"required":true,"variadic":false,"settable":false}],"returns":["content"],"scope":[]}]}}}