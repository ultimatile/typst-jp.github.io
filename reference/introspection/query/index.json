{"route":"/docs/reference/introspection/query/","title":"Query","description":"Documentation for the `query` function.","part":null,"outline":[{"id":"summary","name":"概要","children":[]},{"id":"要素の探索","name":"要素の探索","children":[]},{"id":"caution","name":"注意事項","children":[]},{"id":"コマンドラインクエリ","name":"コマンドラインクエリ","children":[]},{"id":"parameters","name":"引数","children":[{"id":"parameters-target","name":"target","children":[]}]}],"body":{"kind":"func","content":{"path":[],"name":"query","title":"Query","keywords":[],"oneliner":"文書中の要素の検索。","element":false,"contextual":true,"deprecation":null,"details":"<p>文書中の要素の検索。</p>\n<p><code>query</code>関数を用いると特定の型やラベルを持った要素を文書内から探すことができます。\n使用するにはまず<a href=\"/docs/reference/context/\">コンテキスト</a>が利用可能であることを確かめる必要があります。</p>\n<h2 id=\"要素の探索\">要素の探索</h2>\n<p>以下の例では、<a href=\"/docs/reference/model/outline/\" title=\"`outline`\"><code>outline</code></a>を用いる代わりに手動で目次を作成しています。</p>\n<p>このために、まず第1レベルの見出しで<code>outlined</code>がtrueなものを検索します。\nこの例において第1レベルの見出しのみを検索する目的は、第2レベル以下の見出しが目次に含まれないようにすることです。\n<code>outlined</code>フィールドは&quot;Table of Contents&quot;という見出し自身を取り除くために使われます。</p>\n<p><code>query</code>関数を使用可能にするために、<code>context</code>を作成していることに注意してください。</p>\n<div class=\"previewed-code\"><pre><code><span class=\"typ-key\">#</span><span class=\"typ-key\">set</span> <span class=\"typ-func\">page</span><span class=\"typ-punct\">(</span>numbering<span class=\"typ-punct\">:</span> <span class=\"typ-str\">&quot;1&quot;</span><span class=\"typ-punct\">)</span>\n\n<span class=\"typ-func\">#</span><span class=\"typ-func\">heading</span><span class=\"typ-punct\">(</span>outlined<span class=\"typ-punct\">:</span> <span class=\"typ-key\">false</span><span class=\"typ-punct\">)</span><span class=\"typ-punct\">[</span>\n  Table of Contents\n<span class=\"typ-punct\">]</span>\n<span class=\"typ-key\">#</span><span class=\"typ-key\">context</span> <span class=\"typ-punct\">{</span>\n  <span class=\"typ-key\">let</span> chapters <span class=\"typ-op\">=</span> <span class=\"typ-func\">query</span><span class=\"typ-punct\">(</span>\n    heading<span class=\"typ-punct\">.</span><span class=\"typ-func\">where</span><span class=\"typ-punct\">(</span>\n      level<span class=\"typ-punct\">:</span> <span class=\"typ-num\">1</span><span class=\"typ-punct\">,</span>\n      outlined<span class=\"typ-punct\">:</span> <span class=\"typ-key\">true</span><span class=\"typ-punct\">,</span>\n    <span class=\"typ-punct\">)</span>\n  <span class=\"typ-punct\">)</span>\n  <span class=\"typ-key\">for</span> chapter <span class=\"typ-key\">in</span> chapters <span class=\"typ-punct\">{</span>\n    <span class=\"typ-key\">let</span> loc <span class=\"typ-op\">=</span> chapter<span class=\"typ-punct\">.</span><span class=\"typ-func\">location</span><span class=\"typ-punct\">(</span><span class=\"typ-punct\">)</span>\n    <span class=\"typ-key\">let</span> nr <span class=\"typ-op\">=</span> <span class=\"typ-func\">numbering</span><span class=\"typ-punct\">(</span>\n      loc<span class=\"typ-punct\">.</span><span class=\"typ-func\">page-numbering</span><span class=\"typ-punct\">(</span><span class=\"typ-punct\">)</span><span class=\"typ-punct\">,</span>\n      <span class=\"typ-op\">..</span><span class=\"typ-func\">counter</span><span class=\"typ-punct\">(</span>page<span class=\"typ-punct\">)</span><span class=\"typ-punct\">.</span><span class=\"typ-func\">at</span><span class=\"typ-punct\">(</span>loc<span class=\"typ-punct\">)</span><span class=\"typ-punct\">,</span>\n    <span class=\"typ-punct\">)</span>\n    <span class=\"typ-punct\">[</span><span class=\"typ-pol\">#</span><span class=\"typ-pol\">chapter</span><span class=\"typ-punct\">.</span><span class=\"typ-pol\">body</span> <span class=\"typ-func\">#</span><span class=\"typ-func\">h</span><span class=\"typ-punct\">(</span><span class=\"typ-num\">1fr</span><span class=\"typ-punct\">)</span> <span class=\"typ-pol\">#</span><span class=\"typ-pol\">nr</span> <span class=\"typ-escape\">\\</span> <span class=\"typ-punct\">]</span>\n  <span class=\"typ-punct\">}</span>\n<span class=\"typ-punct\">}</span>\n\n<span class=\"typ-heading\">= Introduction</span>\n<span class=\"typ-func\">#</span><span class=\"typ-func\">lorem</span><span class=\"typ-punct\">(</span><span class=\"typ-num\">10</span><span class=\"typ-punct\">)</span>\n<span class=\"typ-func\">#</span><span class=\"typ-func\">pagebreak</span><span class=\"typ-punct\">(</span><span class=\"typ-punct\">)</span>\n\n<span class=\"typ-heading\">== Sub-Heading</span>\n<span class=\"typ-func\">#</span><span class=\"typ-func\">lorem</span><span class=\"typ-punct\">(</span><span class=\"typ-num\">8</span><span class=\"typ-punct\">)</span>\n\n<span class=\"typ-heading\">= Discussion</span>\n<span class=\"typ-func\">#</span><span class=\"typ-func\">lorem</span><span class=\"typ-punct\">(</span><span class=\"typ-num\">18</span><span class=\"typ-punct\">)</span>\n</code></pre><div class=\"preview\"><img src=\"/docs/assets/8e8f9e9bb6b78c544e7cd2dd55edf70b.png\" alt=\"Preview\"></div></div>\n<p>ページ番号を取得するために、まず<a href=\"/docs/reference/foundations/content/#definitions-location\"><code>location</code></a>メソッドを用いて<code>query</code>が返す要素のロケーションを取得します。\n続けて、その位置にある<a href=\"/docs/reference/introspection/location/#definitions-page-numbering\">ページの番号付け</a>と<a href=\"/docs/reference/introspection/counter/#page-counter\">ページカウンター</a>を取得し、カウンターに番号付けを適用します。</p>\n<h2 id=\"caution\">注意事項</h2>\n<p>全てのクエリを解決するために、Typstは文書の評価とレイアウトを複数回行います。\nしかしながら、実際にクエリが完全に解決されるかは保証されません。\n注意しないとクエリ自身に影響しうるクエリを書いてしまい、結果が決して収束しなくなります。</p>\n<p>以下の例では、文書中の全ての見出しを検索し、同じ数だけ見出しを生成しています。\n最初は<code>Real</code>という見出しが1つだけあります。\nしたがって、<code>count</code>は<code>1</code>で、<code>Fake</code>という見出しが作成されます。\nTypstはクエリの結果が変わったことに気づき、再度処理を行います。\nこのとき<code>count</code>は<code>2</code>で、 2つの<code>Fake</code>見出しが作成されます。\nこれが延々と続きます。\nご覧の通り、出力には有限個の見出ししかありません。\nこれは単にTypstが数回試行した後に諦めるためです。</p>\n<p>一般に、クエリ自身に影響を与えるようなクエリを書こうとしてはいけません。\n<a href=\"/docs/reference/introspection/counter/\">カウンター</a>や<a href=\"/docs/reference/introspection/state/\">状態</a>などの他の内省機能にも同じ注意が必要です。</p>\n<div class=\"previewed-code\"><pre><code><span class=\"typ-heading\">= Real</span>\n<span class=\"typ-key\">#</span><span class=\"typ-key\">context</span> <span class=\"typ-punct\">{</span>\n  <span class=\"typ-key\">let</span> elems <span class=\"typ-op\">=</span> <span class=\"typ-func\">query</span><span class=\"typ-punct\">(</span>heading<span class=\"typ-punct\">)</span>\n  <span class=\"typ-key\">let</span> count <span class=\"typ-op\">=</span> elems<span class=\"typ-punct\">.</span><span class=\"typ-func\">len</span><span class=\"typ-punct\">(</span><span class=\"typ-punct\">)</span>\n  count <span class=\"typ-op\">*</span> <span class=\"typ-punct\">[</span><span class=\"typ-heading\">= Fake</span><span class=\"typ-punct\">]</span>\n<span class=\"typ-punct\">}</span>\n</code></pre><div class=\"preview\"><img src=\"/docs/assets/b66e3cb3bae911d3a0525883200bcf7.png\" alt=\"Preview\"></div></div>\n<h2 id=\"コマンドラインクエリ\">コマンドラインクエリ</h2>\n<p><code>typst query</code>コマンドを用いてコマンドラインからクエリを実行することもできます。\nこのコマンドは文書上で任意のクエリを実行し、シリアライズされた形で結果の要素を返します。\n以下の何らかの不可視の<a href=\"/docs/reference/introspection/metadata/\">メタデータ</a>を含んだ<code>example.typ</code>ファイルを考えます。</p>\n<pre><code><span class=\"typ-func\">#</span><span class=\"typ-func\">metadata</span><span class=\"typ-punct\">(</span><span class=\"typ-str\">&quot;This is a note&quot;</span><span class=\"typ-punct\">)</span> <span class=\"typ-label\">&lt;note&gt;</span>\n</code></pre>\n<p>Typst CLIを用いて以下のようにこのファイルに対してクエリを実行できます。</p>\n<pre style=\"background-color:#ffffff;\">\n<span style=\"color:#4b69c6;\">$</span><span style=\"color:#000000;\"> typst query example.typ </span><span style=\"color:#298e0d;\">&quot;&lt;note&gt;&quot;\n</span><span style=\"color:#4b69c6;\">[\n</span><span style=\"color:#000000;\">  {\n</span><span style=\"color:#000000;\">    </span><span style=\"color:#298e0d;\">&quot;func&quot;</span><span style=\"color:#4b69c6;\">: </span><span style=\"color:#298e0d;\">&quot;metadata&quot;</span><span style=\"color:#000000;\">,\n</span><span style=\"color:#000000;\">    </span><span style=\"color:#298e0d;\">&quot;value&quot;</span><span style=\"color:#4b69c6;\">: </span><span style=\"color:#298e0d;\">&quot;This is a note&quot;</span><span style=\"color:#000000;\">,\n</span><span style=\"color:#000000;\">    </span><span style=\"color:#298e0d;\">&quot;label&quot;</span><span style=\"color:#4b69c6;\">: </span><span style=\"color:#298e0d;\">&quot;&lt;note&gt;&quot;\n</span><span style=\"color:#000000;\">  }\n</span><span style=\"color:#4b69c6;\">]\n</span></pre>\n<p>結果となる要素の特定の1つのフィールドにのみ興味があることが多いです。\n<code>metadata</code>要素の場合、<code>value</code>フィールドが興味の対象です。\n<code>--field</code>引数を用いてこのフィールドのみを抽出できます。</p>\n<pre style=\"background-color:#ffffff;\">\n<span style=\"color:#4b69c6;\">$</span><span style=\"color:#000000;\"> typst query example.typ </span><span style=\"color:#298e0d;\">&quot;&lt;note&gt;&quot;</span><span style=\"color:#000000;\"> --field value\n</span><span style=\"color:#4b69c6;\">[</span><span style=\"color:#298e0d;\">&quot;This is a note&quot;</span><span style=\"color:#4b69c6;\">]\n</span></pre>\n<p>単一の要素にのみ興味がある場合は、<code>--one</code>フラグを用いてその要素のみを抽出できます。</p>\n<pre style=\"background-color:#ffffff;\">\n<span style=\"color:#4b69c6;\">$</span><span style=\"color:#000000;\"> typst query example.typ </span><span style=\"color:#298e0d;\">&quot;&lt;note&gt;&quot;</span><span style=\"color:#000000;\"> --field value --one\n</span><span style=\"color:#298e0d;\">&quot;This is a note&quot;\n</span></pre>","example":null,"self":false,"params":[{"name":"target","details":"<ul>\n<li><code>heading</code>や<code>figure</code>のような要素関数</li>\n<li><code><span class=\"typ-label\">&lt;label&gt;</span></code></li>\n<li><code>heading<span class=\"typ-punct\">.</span><span class=\"typ-func\">where</span><span class=\"typ-punct\">(</span>level<span class=\"typ-punct\">:</span> <span class=\"typ-num\">1</span><span class=\"typ-punct\">)</span></code>のような、より複雑なセレクター</li>\n<li><code><span class=\"typ-func\">selector</span><span class=\"typ-punct\">(</span>heading<span class=\"typ-punct\">)</span><span class=\"typ-punct\">.</span><span class=\"typ-func\">before</span><span class=\"typ-punct\">(</span><span class=\"typ-func\">here</span><span class=\"typ-punct\">(</span><span class=\"typ-punct\">)</span><span class=\"typ-punct\">)</span></code></li>\n</ul>\n<p>が可能です。</p>\n<p><a href=\"/docs/reference/introspection/location/#locatable\">ロケータブル</a>要素関数がサポートされています。</p>","example":null,"types":["label","selector","location","function"],"strings":[],"default":null,"positional":true,"named":false,"required":true,"variadic":false,"settable":false}],"returns":["array"],"scope":[]}}}